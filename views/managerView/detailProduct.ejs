<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <meta content="IE=edge" http-equiv="X-UA-Compatible">
                <title>
                    Product name
                </title>
                <link href="/truong/detailProduct.css" rel="stylesheet">
                </link>
                <script src="/truong/echarts.js">
                </script>
                <link rel="stylesheet" type="text/css" href="/truong/getAllProduct.css">
            </meta>
        </meta>
    </head>
    <body>
        <div class="info" id="productId" style="display: none;"><%=product.id%></div>
        <div class="container">
            <!-- navigation -->
            <div class="navigation">
                <ul>
                    <li>
                        <a href="/">
                            <span class="icon">
                                <img src="/truong/img/logo.png" style="width: 40px; margin-top: 5px;">
                            </span>
                            <span class="title">
                                Shibar Mart
                            </span>
                        </a>
                    </li>
                    <li class="">
                        <a href="/admin">
                            <span class="icon">
                                <ion-icon name="home-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Dashboard
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/staffmanager">
                            <span class="icon">
                                <ion-icon name="person-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                HR Management
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/statistic">
                            <span class="icon">
                                <ion-icon name="trending-up-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Statistic
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/shiftmanager">
                            <span class="icon">
                                <ion-icon name="checkmark-done-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Shift Manager
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/admin/hourstatistic">
                            <span class="icon">
                                <ion-icon name="time-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Hour Statistic
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="">
                            <span class="icon">
                                <ion-icon name="chatbubble-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Message
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="">
                            <span class="icon">
                                <ion-icon name="settings-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Settings
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="/logout/staff">
                            <span class="icon">
                                <ion-icon name="log-out-outline">
                                </ion-icon>
                            </span>
                            <span class="title">
                                Sign out
                            </span>
                        </a>
                    </li>
                </ul>
            </div>
            <!-- main -->
            <div class="main">
                <!-- topbar -->
                <div class="topbar">
                    <div class="toggle">
                        <ion-icon name="menu-outline">
                        </ion-icon>
                    </div>
                    <!-- search -->
                    <div class="search">
                        <label>
                            <input placeholder="Search here" type="text" id="searchBar">
                                <ion-icon name="search-outline">
                                </ion-icon>
                                <div class="table card hide" id="result">
                                    
                                </div>
                            </input>
                        </label>
                    </div>
                    <!-- user image -->
                    <div class="user">
                        <img alt="User" src="truong/img/user.jpg">
                        </img>
                    </div>
                </div>
                <div class="mainContent">
                    <div class="card productName">
                            
                            <div class="img"><img src="<%=product.good_img%>"></div>
                            <div class="cardHeader"><%=product.name%></div>
                        </div>
                    <div class="analytic">
                        
                        <div class="card inventory">
                            <div>
                                <div class="cardHeader">
                                    Inventory
                                </div>
                                <div class="cardNumber">
                                    <%=inventory%>
                                </div>    
                            </div>
                            
                            <ion-icon name="cart-outline">
                            </ion-icon>
                        </div>
                        <div class="card totalPurchase">
                            <div>
                                <div class="cardHeader">
                                    Total Purchase
                                </div>
                                <div class="cardNumber">
                                    <%=totalPurchase%> Đ
                                </div>    
                            </div>
                            
                            <ion-icon name="cart-outline">
                            </ion-icon>
                        </div>
                        <div class="card totalSell">
                            <div>
                                <div class="cardHeader">
                                    Total Sell
                                </div>
                                <div class="cardNumber">
                                    <%=totalSell%> Đ
                                </div>    
                            </div>
                            
                            <ion-icon name="bag-check-outline">
                            </ion-icon>
                        </div>
                        <div class="card totalEarn">
                            <div>
                                <div class="cardHeader">
                                    Total Income
                                </div>
                                <div class="cardNumber">
                                    <%=totalIncomes%> Đ
                                </div>    
                            </div>
                            
                            <ion-icon name="cash-outline">
                            </ion-icon>
                        </div>
                    </div>
                    <div class="chart">
                        <div class="chartContainer card">
                            <div class="selection">
                                <button id="weekButton"  proId="<%=product.id%>">This Week</button>
                                <button id="monthButton"  proId="<%=product.id%>">This Month</button>
                                <button id="yearButton"   proId="<%=product.id%>">This Year</button>
                            </div>
                            <div class="mainChart" id="mainChart" style="width: 100%; height: 500px;">
                            </div>
                        </div>
                        <div class="subChart">
                            <div class="recentPurchase card">
                                <div class="cardHeader">
                                    Recent Purchase
                                </div>
                                <div class="table">
                                    <div class="row">
                                        <div class="cell">
                                            Time
                                        </div>
                                        <div class="cell">
                                            Quantity
                                        </div>
                                        <div class="cell">
                                            Price
                                        </div>
                                    </div>
                                    <%for (var i = 0; i < recentPurchase.length; i++) {%>
                                        <%const item = recentPurchase[i]%>
                                    <div class="row">
                                        <div class="cell">
                                            <%=item.time%>
                                        </div>
                                        <div class="cell">
                                            <%=item.amount%>
                                        </div>
                                        <div class="cell">
                                            <%=item.amount * item.price%>
                                        </div>
                                    </div>
                                    <%}%>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sideBar">
                    <div class="card settingForm">
                        <div class="cardHeader">
                            Update Info
                        </div>
                        <div class="form">
                            <div class="formElement">
                                <label>
                                    Purchase Price: <span id="vl0"><%=product.buyPrice%></span> Đ
                                </label>
                                <input name="buyPrice" placeholder="Purchase Price (VND)" type="number" id="buyPrice" proId="<%=product.id%>">
                                </input>    
                                <button onclick="updateBuyPrice(<%=product.id%>)" id="btn0">Change</button>
                            </div>
                            <div class="formElement">
                                <label>
                                    Sell Price: <span id="vl1"><%=product.sellPrice%></span> Đ
                                </label>
                                <input name="sellPrice" placeholder="Sell Price (VND)" type="number" id="sellPrice" proId="<%=product.id%>">
                                </input>    
                                <button onclick="updateSellPrice(<%=product.id%>)" id="btn1">Change</button>
                            </div>
                            <div class="formElement">
                                <label>
                                    Discount: <span id="vl2"><%=product.discount%></span> %
                                </label>
                                <input name="discount" placeholder="(0 - 100)%" type="number" id="discount" proId="<%=product.id%>">
                                </input>    
                                <button onclick="updateDiscount(<%=product.id%>)" id="btn2">Change</button>
                            </div>
                        </div>
                    </div>
                    <div class="card relativeProduct">
                        <div class="cardHeader">
                            Relative Product
                        </div>
                        <%for (var i = 0; i < relativeProduct.length; i++) {%>
                            <%const item = relativeProduct[i];%>
                            <div class="pro">
                                <div class="proImg">
                                    <img src="<%=item.good_img%>">
                                    </img>
                                </div>
                                <div class="proName">
                                    <%=item.name%>
                                </div>
                            </div>    
                        <%}%>
                        
                        
                    
                </div>
            </div>
        </div>
        <script src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js" type="module">
        </script>
        <script nomodule="" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js">
        </script>
        <script type="text/javascript">
            //menu toggle
		    let toggle = document.querySelector('.toggle');
		    let main = document.querySelector('.main');
		    let navigation = document.querySelector('.navigation');

		    toggle.onclick = function(){
		      navigation.classList.toggle('active');
		      main.classList.toggle('active');
		    }

		    //add hovered class for selected list item
		    let list = document.querySelectorAll('.navigation li');
		    function hoveredLink(){
		      this.classList.add('hovered');
		    }
		    function unhoveredLink(){
		      this.classList.remove('hovered')
		    }
		    list.forEach((item)=>{
		      item.addEventListener('mouseover', hoveredLink);
		      item.addEventListener('mouseleave', unhoveredLink);
		    });
        </script>
        <script type="text/javascript">
            var chartDom1 = document.getElementById('mainChart');
            
    		var mainChart = echarts.init(chartDom1);
            

    		window.onresize = function () {
      			mainChart.resize();
    		};

    		var mainChartOption;

		    mainChartOption = {
		      title: {
		        text: 'Buy and Sales'
		      },
		      tooltip: {
		        trigger: 'axis'
		      },
		      legend: {
		        data: ['Buy', 'Sell']
		      },
		      toolbox: {
		        show: false,
		        feature: {
		          dataView: { show: true, readOnly: false },
		          magicType: { show: true, type: ['line', 'bar'] },
		          restore: { show: true },
		          saveAsImage: { show: true }
		        }
		      },
		      calculable: true,
		      xAxis: [
		        {
		          type: 'category',
		          // prettier-ignore
		          data: ["one", "two", "three"],
                  axisLabel: { interval: 0, rotate: 30 }
		        }
		      ],
		      yAxis: [
		        {
		          type: 'value'
		        }
		      ],
		      series: [
		        {
		          name: 'Buy',
		          type: 'bar',
		          data: [1, 2, 3],
		          markPoint: {
		            data: [
		              { type: 'max', name: 'Max' },
		              { type: 'min', name: 'Min' }
		            ]
		          }
		          
		        },
		        {
		          name: 'Sell',
		          type: 'bar',
		          data: [2, 3, 4],
		          markPoint: {
		            data: [
		              { type: 'max', name: 'Max' },
		              { type: 'min', name: 'Min' }
		            ]
		          }
		          
		        }
		      ]
		    };

		    mainChartOption.color = [
		      '#999',
		      '#287bff'
		    ]

		    mainChartOption && mainChart.setOption(mainChartOption);
            
            let weekData;
            let monthData;
            let yearData;

            const productId = document.getElementById('productId');

            const buyPrice = document.getElementById('buyPrice');
            const sellPrice = document.getElementById("sellPrice");
            const discount = document.getElementById("discount");
            //trigger event when press enter
            sellPrice.addEventListener('keyup', function(event){
                if(event.keyCode === 13){
                    updateSellPrice(productId.innerText);
                }
            })
            discount.addEventListener('keyup', function(event){
                if(event.keyCode === 13){
                    updateDiscount(productId.innerText);
                }
            })
            buyPrice.addEventListener('keyup', function(event){
                if(event.keyCode === 13){
                    updateBuyPrice(productId.innerText);
                }
            })



            const xhttp = new XMLHttpRequest();
            xhttp.onload = function(){
                if(this.status == 401){
                    const ask = confirm("Bạn không có quyền truy cập vào địa chỉ này.");
                    if(ask) location.href = "/login/staff";
                    return;
                }
                if(this.status == 403){
                    const ask = confirm("Phiên của bạn đã hết hạn, bạn có muốn đăng nhập lại không?");
                    if(ask) location.href = "/login/staff";
                    return;
                }
                const data = JSON.parse(this.responseText);

                if(data.message != 'OK'){
                    alert(data.message);
                    
                    if(data.type == "price"){
                        const vl1 = document.getElementById('vl1');
                        vl1.innerText = data.newValue;
                    }
                    if(data.type == "discount"){
                        const vl2 = document.getElementById('vl2');
                        vl2.innerText = data.newValue;
                    }
                    if(data.type == "buyPrice"){
                        const vl0 = document.getElementById('vl0');
                        vl0.innerText = data.newValue;
                    }
                    
                } else {
                    if(data.type == 'week') {
                        weekData = data;
                        getMonthData();   
                        
                    }
                    if(data.type == 'month') {
                        monthData = data;
                        
                        getYearData();    
                    }
                    
                    if(data.type == 'year') {
                        yearData = data;
                        
                    }
                    
                }
            }

            
            //get week data
            function getWeekData(){
                xhttp.open('GET', ('/admin/getWeekData/' + productId.innerText));
                xhttp.send();    
            }
            getWeekData();
            
            //get month data
            function getMonthData(){
                const url = '/admin/getMonthData/' + productId.innerText;
                xhttp.open('GET', url);
                xhttp.send();
            }
            
            
            //get year data
            function getYearData(){
                const url = '/admin/getYearData/' + productId.innerText;
                xhttp.open('GET', url);
                xhttp.send();
            }
            


            function updateSellPrice(id){
                if (sellPrice.value != "" && !isNaN(Number(sellPrice.value))) {
                    const url1 = '/admin/updateSellPrice/' + id + '/' + sellPrice.value;
                    xhttp.open('PUT', url1);
                    xhttp.send();    
                } else {
                    alert('Please input the right value.')
                }
            }

            function updateDiscount(id){
                if (discount.value != "" && !isNaN(Number(discount.value))) {
                    const url = '/admin/updateDiscount/' + id + '/' + discount.value;
                    xhttp.open('PUT', url);
                    xhttp.send();
                } else {
                    alert('Please input the right value.')
                }
            }

            function updateBuyPrice(id){
                if (buyPrice.value != "" && !isNaN(Number(buyPrice.value))) {
                    const url = '/admin/updateBuyPrice/' + id + '/' + buyPrice.value;
                    xhttp.open('PUT', url);
                    xhttp.send();
                } else {
                    alert('Please input the right value.')
                }   
            }


            const weekButton = document.getElementById('weekButton');
            weekButton.addEventListener('click', function(){
                mainChartOption.xAxis[0].data = weekData.label;
                mainChartOption.series[0].data = weekData.buyData;
                mainChartOption.series[1].data = weekData.sellData;
                mainChartOption && mainChart.setOption(mainChartOption);
            })

            const monthButton = document.getElementById('monthButton');
            monthButton.addEventListener('click', function(){
                mainChartOption.xAxis[0].data = monthData.label;
                mainChartOption.series[0].data = monthData.buyData;
                mainChartOption.series[1].data = monthData.sellData;
                mainChartOption && mainChart.setOption(mainChartOption);  
            })

            const yearButton = document.getElementById('yearButton');
            yearButton.addEventListener('click', function(){
                mainChartOption.xAxis[0].data = yearData.label;
                mainChartOption.series[0].data = yearData.buyData;
                mainChartOption.series[1].data = yearData.sellData;
                mainChartOption && mainChart.setOption(mainChartOption);  
            })
        </script>
        <script type="text/javascript" src="/truong/getAllProduct.js"></script>
    </body>
</html>